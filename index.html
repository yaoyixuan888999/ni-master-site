<script>
  const typeSelect = document.getElementById('analysisType');
  const imageUploadBlock = document.getElementById('imageUploadBlock');
  const birthInputBlock = document.getElementById('birthInputBlock');

  typeSelect.addEventListener('change', () => {
    if (typeSelect.value === 'bazi') {
      imageUploadBlock.classList.add('hidden');
      birthInputBlock.classList.remove('hidden');
    } else {
      imageUploadBlock.classList.remove('hidden');
      birthInputBlock.classList.add('hidden');
    }
  });

  async function submitData() {
    const type = document.getElementById('analysisType').value;
    const imageInput = document.getElementById('imageInput');
    const birth = document.getElementById('birthInput')?.value || '';
    const result = document.getElementById('resultBlock');
    const resultText = document.getElementById('resultText');

    result.classList.remove('hidden');
    resultText.innerText = 'â³ å€ªå¤§å¸ˆææŒ‡ä¸€ç®—ä¸­ï¼Œè¯·ç¨å€™...';

    if (type !== 'bazi' && imageInput.files.length === 0) {
      resultText.innerText = 'è¯·ä¸Šä¼ å›¾åƒåå†æäº¤ã€‚';
      return;
    }

    let base64Image = '';
    if (type !== 'bazi') {
      const file = imageInput.files[0];
      base64Image = await toBase64(file);
    }

    const payload = {
      type,
      birth,
      image: base64Image,
      time: new Date().toISOString()
    };

    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error('æœåŠ¡å™¨å“åº”å¤±è´¥');

      // å¼€å§‹è½®è¯¢ç»“æœ
      pollForResult();
    } catch (error) {
      console.error('æäº¤å¤±è´¥ï¼š', error);
      resultText.innerText = 'âŒ æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
    }
  }

  async function pollForResult() {
    const resultText = document.getElementById('resultText');
    let attempts = 0;
    const maxAttempts = 15;

    while (attempts < maxAttempts) {
      try {
        const response = await fetch('http://localhost:5001/result');
        const data = await response.json();

        if (data.status === 'done') {
          resultText.innerText = `ğŸ§™â€â™‚ï¸ å€ªå¤§å¸ˆè§£ç­”ï¼š\n\n${data.reply}`;
          return;
        } else if (data.status === 'pending') {
          resultText.innerText = 'ğŸ” æ­£åœ¨ä¸ºæ‚¨ææŒ‡ä¸€ç®—ï¼Œè¯·ç¨å€™...';
        }
      } catch (error) {
        resultText.innerText = 'âš ï¸ æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚';
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;
    }

    resultText.innerText = 'âš ï¸ åˆ†æè¶…æ—¶ï¼Œè¯·é‡æ–°æäº¤æˆ–ç¨åå†è¯•ã€‚';
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }
</script>
