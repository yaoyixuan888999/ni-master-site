<script>
  const typeSelect = document.getElementById('analysisType');
  const imageUploadBlock = document.getElementById('imageUploadBlock');
  const birthInputBlock = document.getElementById('birthInputBlock');

  typeSelect.addEventListener('change', () => {
    if (typeSelect.value === 'bazi') {
      imageUploadBlock.classList.add('hidden');
      birthInputBlock.classList.remove('hidden');
    } else {
      imageUploadBlock.classList.remove('hidden');
      birthInputBlock.classList.add('hidden');
    }
  });

  async function submitData() {
    const type = document.getElementById('analysisType').value;
    const imageInput = document.getElementById('imageInput');
    const birth = document.getElementById('birthInput')?.value || '';
    const result = document.getElementById('resultBlock');
    const resultText = document.getElementById('resultText');

    result.classList.remove('hidden');
    resultText.innerText = '⏳ 倪大师掐指一算中，请稍候...';

    if (type !== 'bazi' && imageInput.files.length === 0) {
      resultText.innerText = '请上传图像后再提交。';
      return;
    }

    let base64Image = '';
    if (type !== 'bazi') {
      const file = imageInput.files[0];
      base64Image = await toBase64(file);
    }

    const payload = {
      type,
      birth,
      image: base64Image,
      time: new Date().toISOString()
    };

    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error('服务器响应失败');

      // 开始轮询结果
      pollForResult();
    } catch (error) {
      console.error('提交失败：', error);
      resultText.innerText = '❌ 提交失败，请稍后再试。';
    }
  }

  async function pollForResult() {
    const resultText = document.getElementById('resultText');
    let attempts = 0;
    const maxAttempts = 15;

    while (attempts < maxAttempts) {
      try {
        const response = await fetch('http://localhost:5001/result');
        const data = await response.json();

        if (data.status === 'done') {
          resultText.innerText = `🧙‍♂️ 倪大师解答：\n\n${data.reply}`;
          return;
        } else if (data.status === 'pending') {
          resultText.innerText = '🔍 正在为您掐指一算，请稍候...';
        }
      } catch (error) {
        resultText.innerText = '⚠️ 服务器暂时不可用，请稍后再试。';
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 2000));
      attempts++;
    }

    resultText.innerText = '⚠️ 分析超时，请重新提交或稍后再试。';
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }
</script>
